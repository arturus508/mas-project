<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: headNoArg}"></head>
<body data-mode="mind">
<div th:replace="~{fragments/nav :: nav}"></div>

<div class="container py-4">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
    <h2 class="m-0">Habits - streak + mini heatmap (28d)</h2>
    <a href="/today" class="btn btn-outline-secondary btn-sm">Back to Today</a>
  </div>

  <form method="get" action="#" class="form-inline-actions mb-3">
    <div class="form-fields">
      <div class="span-4">
        <label class="form-label" for="date">Reference date</label>
        <input id="date" name="date" type="date" class="form-control form-control-sm" th:value="${date}">
        <div class="form-text">Heatmap ends on this date.</div>
      </div>
    </div>
    <div class="form-actions">
      <button type="submit" class="btn btn-sm btn-outline-primary">Go</button>
    </div>
  </form>

  <style>
    .heat{ display:flex; gap:4px; align-items:center; }
    .cell{ width:14px; height:14px; border:1px solid #d0d7de; background:#fff; border-radius:3px; padding:0; }
    .cell.on{ background:#2ea043; border-color:#2ea043; }
    .cell:focus{ outline:1px solid #57606a; }
    .name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:420px; }
    .row{ display:grid; grid-template-columns: 1fr auto; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid #f0f0f0; }
    .streak{ font-size:12px; color:#666; }
    .target{ font-weight:600; margin-left:6px; color:#444; }
  </style>

  <div class="card mb-3">
    <div class="card-header section-header">
      <div class="section-title">Add habit</div>
    </div>
    <div class="card-body">
    <form method="post" th:action="@{/flow/habits}" class="form-inline-actions">
      <div th:replace="~{fragments/csrf :: csrf}"></div>
      <input type="hidden" name="date" th:value="${date}">
      <div class="form-fields">
        <div class="span-5">
          <label class="form-label">Habit name</label>
          <input name="name" class="form-control form-control-sm" aria-label="Habit name" placeholder="Habit name" required>
        </div>
        <div class="span-2">
          <label class="form-label">Per day</label>
          <input name="targetPerDay" type="number" min="1" value="1" class="form-control form-control-sm" aria-label="Target per day" placeholder="Per day">
        </div>
        <div class="span-2">
          <label class="form-label">Per week</label>
          <input name="targetPerWeek" type="number" min="1" value="3" class="form-control form-control-sm" aria-label="Target per week" placeholder="Per week">
        </div>
        <div class="span-3">
          <label class="form-label">Cadence</label>
          <select name="cadence" class="form-select form-select-sm" aria-label="Cadence">
            <option value="DAILY">Daily</option>
            <option value="WEEKLY">Weekly</option>
          </select>
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-sm btn-outline-primary">Add</button>
      </div>
      <div class="form-text">
        Targets: per day / per week (used for streak + progress).
      </div>
    </form>
    </div>
  </div>

  <h3 style="margin: 12px 0 6px;">Your habits</h3>
  <div th:if="${#lists.isEmpty(habits)}" style="color:#666;">No habits yet.</div>

  <div th:each="h : ${habits}" class="row">
    <div class="name">
      <strong th:text="${h.name}">Habit</strong>
      <span class="target"
            th:text="${h.cadence == 'WEEKLY'} ? ('x' + ${h.targetPerWeek} + '/week') : ('x' + ${h.targetPerDay} + '/day')"
            th:title="${h.cadence == 'WEEKLY'} ? ('Target ' + ${h.targetPerWeek} + ' per week') : ('Target ' + ${h.targetPerDay} + ' per day')">x1</span>
      <span class="streak">
        streak:
        <span th:text="${streaks[h.id]}">0</span>
        <span th:text="${h.cadence == 'WEEKLY'} ? ' weeks' : ' days'">days</span>
      </span>
    </div>

    <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end;">
      <form method="post" th:action="@{/flow/habits/toggle/{id}(id=${h.id})}" style="display:inline;">
        <div th:replace="~{fragments/csrf :: csrf}"></div>
        <input type="hidden" name="date" th:value="${date}">
        <input type="hidden" name="refDate" th:value="${date}">
        <button type="submit"
                class="btn btn-xs btn-outline-primary"
                th:text="${today[h.id]} ? 'x' : ''" aria-label="toggle today"></button>
      </form>

      <form method="post" th:action="@{/flow/habits/{id}/archive(id=${h.id})}" style="display:inline;">
        <div th:replace="~{fragments/csrf :: csrf}"></div>
        <input type="hidden" name="date" th:value="${date}">
        <button type="submit" class="btn btn-xs btn-outline-warning">Archive</button>
      </form>

      <form method="post" th:action="@{/flow/habits/{id}/delete(id=${h.id})}" style="display:inline;">
        <div th:replace="~{fragments/csrf :: csrf}"></div>
        <input type="hidden" name="date" th:value="${date}">
        <button type="submit" class="btn btn-xs btn-outline-danger">Delete</button>
      </form>
    </div>

    <div class="heat" style="grid-column: 1 / -1;">
      <div th:each="d : ${windowDays}" style="display:inline;">
        <form method="post" th:action="@{/flow/habits/toggle/{id}(id=${h.id})}" style="display:inline;">
          <div th:replace="~{fragments/csrf :: csrf}"></div>
          <input type="hidden" name="date"    th:value="${#temporals.format(d,'yyyy-MM-dd')}">
          <input type="hidden" name="refDate" th:value="${date}">
          <button type="submit" class="cell"
                  th:classappend="${heat[h.id][#temporals.format(d,'yyyy-MM-dd')]} ? ' on' : ''"
                  th:title="${#temporals.format(d,'EEE, yyyy-MM-dd')}"></button>
        </form>
      </div>
    </div>
  </div>

  <div style="margin-top:16px;" th:if="${archivedHabits != null && !#lists.isEmpty(archivedHabits)}">
    <h3 style="margin: 12px 0 6px;">Archived habits</h3>
    <div th:each="h : ${archivedHabits}" class="row">
      <div class="name">
        <strong th:text="${h.name}">Habit</strong>
        <span class="target"
              th:text="${h.cadence == 'WEEKLY'} ? ('x' + ${h.targetPerWeek} + '/week') : ('x' + ${h.targetPerDay} + '/day')">x1</span>
      </div>
      <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end;">
      <form method="post" th:action="@{/flow/habits/{id}/restore(id=${h.id})}" style="display:inline;">
        <div th:replace="~{fragments/csrf :: csrf}"></div>
        <input type="hidden" name="date" th:value="${date}">
        <button type="submit" class="btn btn-xs btn-outline-primary">Restore</button>
      </form>
    </div>
  </div>
  </div>
</div>

</body>
</html>
