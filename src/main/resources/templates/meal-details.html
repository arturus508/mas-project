<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Meal Details')}"></head>
<body class="bg-light">
<div th:replace="~{fragments/nav :: nav}"></div>

<div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="mb-1 text-capitalize" th:text="${segment}">Breakfast</h1>
            <div class="text-muted small">
                <span th:text="${date}">2025-08-20</span>
            </div>
        </div>
        <a th:href="@{'/meals?date=' + ${date}}" class="btn btn-outline-secondary btn-sm">Back to Meals</a>
    </div>
    <div class="d-flex flex-wrap gap-2 mb-3">
        <a class="btn btn-sm btn-outline-secondary"
           th:href="@{'/meals/' + ${date} + '/breakfast'}">Breakfast</a>
        <a class="btn btn-sm btn-outline-secondary"
           th:href="@{'/meals/' + ${date} + '/lunch'}">Lunch</a>
        <a class="btn btn-sm btn-outline-secondary"
           th:href="@{'/meals/' + ${date} + '/dinner'}">Dinner</a>
        <a class="btn btn-sm btn-outline-secondary"
           th:href="@{'/meals/' + ${date} + '/snacks'}">Snacks</a>
    </div>
    <div class="alert alert-success py-2" th:if="${param.saved}">
        Item added.
    </div>
    <div class="alert alert-warning py-2" th:if="${param.removed}">
        Item removed.
    </div>

    <div class="card mb-4">
        <div class="card-body d-flex flex-wrap gap-2">
            <span class="badge text-bg-primary" th:text="${totals.kcal} + ' kcal'">0 kcal</span>
            <span class="badge text-bg-secondary" th:text="${totals.protein} + ' P'">0 P</span>
            <span class="badge text-bg-secondary" th:text="${totals.fat} + ' F'">0 F</span>
            <span class="badge text-bg-secondary" th:text="${totals.carbs} + ' C'">0 C</span>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">Items</div>
        <div class="card-body" th:if="${#lists.isEmpty(items)}">
            <div class="text-muted">No items yet. Add your first item below.</div>
        </div>
        <ul class="list-group list-group-flush" th:if="${!#lists.isEmpty(items)}">
            <li class="list-group-item d-flex align-items-center justify-content-between" th:each="item : ${items}">
                <div>
                    <div class="fw-semibold" th:text="${item.foodItem != null ? item.foodItem.name : item.name}">Item</div>
                    <div class="text-muted small" th:if="${item.quantity != null}">
                        <span>Qty: </span>
                        <span th:text="${item.quantity}"></span>
                        <span th:if="${item.foodItem != null}">
                            <span th:text="${item.foodItem.unit == T(com.example.healthfitness.model.Unit).G ? ' g' : ' pcs'}"> g</span>
                        </span>
                    </div>
                </div>
                <form th:action="@{'/meals/' + ${date} + '/' + ${segment} + '/items/' + ${item.id} + '/delete'}" method="post">
                    <div th:replace="~{fragments/csrf :: csrf}"></div>
                    <button type="submit" class="btn btn-xs btn-outline-danger">Remove</button>
                </form>
            </li>
        </ul>
    </div>

    <div class="row g-3">
        <div class="col-lg-7">
            <div class="card h-100">
                <div class="card-header">Add food from database</div>
                <div class="card-body">
                    <form class="form-inline-actions mb-3" method="get" th:action="@{'/meals/' + ${date} + '/' + ${segment}}">
                        <div class="form-fields">
                            <div class="span-12">
                                <label class="form-label" for="foodSearch">Search</label>
                                <input id="foodSearch" type="text" class="form-control form-control-sm" name="q"
                                       placeholder="Type a food name" th:value="${q}">
                                <div class="form-text">Search filters the dropdown list below.</div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-sm btn-outline-primary" type="submit">Search</button>
                        </div>
                    </form>
                    <div class="text-muted small mb-2" th:if="${q != null && !q.isBlank() && #lists.isEmpty(foods)}">
                        No results for "<span th:text="${q}">query</span>".
                    </div>
                    <div class="text-muted small mb-2" th:if="${(q == null || q.isBlank()) && !#lists.isEmpty(foods)}">
                        Showing top foods. Use search to filter.
                    </div>

                    <form th:action="@{'/meals/' + ${date} + '/' + ${segment} + '/items/add-food'}" method="post" class="form-inline-actions">
                        <div th:replace="~{fragments/csrf :: csrf}"></div>
                        <div class="form-fields">
                            <div class="span-8">
                                <label class="form-label" for="foodItemId">Food item</label>
                                <select id="foodItemId" class="form-select form-select-sm" name="foodItemId" required>
                                    <option value="" disabled selected>Select food</option>
                                    <option th:each="f : ${foods}"
                                            th:value="${f.id}"
                                            th:text="${f.name + (f.unit == T(com.example.healthfitness.model.Unit).G ? ' (per 100g)' : ' (per piece)')}">Food</option>
                                </select>
                            </div>
                            <div class="span-4">
                                <label class="form-label" for="foodQuantity">Quantity (g / pcs)</label>
                                <input id="foodQuantity" type="number" class="form-control form-control-sm" name="quantity" min="1" value="100">
                                <div class="form-text">Use grams for foods measured per 100g.</div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-sm btn-outline-primary" type="submit">Add</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card h-100">
                <div class="card-header">Add custom item</div>
                <div class="card-body">
                    <form th:action="@{'/meals/' + ${date} + '/' + ${segment} + '/items/add-custom'}" method="post" class="form-inline-actions">
                        <div th:replace="~{fragments/csrf :: csrf}"></div>
                        <div class="form-fields">
                            <div class="span-12">
                                <label class="form-label" for="customName">Item name</label>
                                <input id="customName" type="text" class="form-control form-control-sm" name="name" placeholder="Item name" required>
                            </div>
                            <div class="span-3">
                                <label class="form-label" for="customKcal">kcal</label>
                                <input id="customKcal" type="number" class="form-control form-control-sm" name="kcal" placeholder="kcal" required>
                            </div>
                            <div class="span-3">
                                <label class="form-label" for="customProtein">protein</label>
                                <input id="customProtein" type="number" class="form-control form-control-sm" name="protein" placeholder="protein" required>
                            </div>
                            <div class="span-3">
                                <label class="form-label" for="customFat">fat</label>
                                <input id="customFat" type="number" class="form-control form-control-sm" name="fat" placeholder="fat" required>
                            </div>
                            <div class="span-3">
                                <label class="form-label" for="customCarbs">carbs</label>
                                <input id="customCarbs" type="number" class="form-control form-control-sm" name="carbs" placeholder="carbs" required>
                            </div>
                            <div class="span-12">
                                <label class="form-label" for="customQuantity">Quantity (optional)</label>
                                <input id="customQuantity" type="number" class="form-control form-control-sm" name="quantity" placeholder="grams or pieces">
                                <div class="form-text">Optional reference only for custom items. Custom items are saved to the food list.</div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-sm btn-outline-primary">Add custom</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
