<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head}"></head>
<body>
<div th:replace="~{fragments/nav :: nav}"></div>

<div class="container" style="max-width: 980px; margin-top: 24px;">
    <h2>Guides</h2>

    <form method="get" action="#" style="margin: 8px 0 16px;">
        <label for="category">Category:</label>
        <select id="category" name="category" onchange="this.form.submit()">
            <option th:value="${null}" th:selected="${selected == null}">All</option>
            <option th:each="c : ${categories}" th:value="${c}" th:text="${c}"
                    th:selected="${selected} == ${c}">RELAXATION</option>
        </select>
        <noscript><button type="submit">Go</button></noscript>
    </form>

    <div style="margin:16px 0; padding:12px; border:1px solid #ddd; border-radius:8px;">
        <h3 style="margin:0 0 8px;">Add guide</h3>
        <form method="post" th:action="@{/flow/guides/add}">
            <div th:replace="~{fragments/csrf :: csrf}"></div>
            <div style="display:grid; grid-template-columns: 1fr 200px; gap:8px;">
                <input name="title" placeholder="Title" required>
                <select name="category" required>
                    <option th:each="c : ${categories}" th:value="${c}" th:text="${c}">RELAXATION</option>
                </select>
            </div>
            <div style="margin-top:8px;">
                <textarea name="content" rows="5" placeholder="Content (HTML/Markdown/Plain)"
                          style="width:100%;" required></textarea>
            </div>
            <div style="margin-top:8px;">
                <input name="mediaUrl" placeholder="Media URL (image or YouTube, optional)" style="width:100%;">
            </div>
            <div style="margin-top:8px;">
                <button type="submit">Add</button>
            </div>
        </form>
    </div>

    <h3 style="margin:16px 0 8px;">Guides list</h3>
    <div th:if="${#lists.isEmpty(guides)}" style="color:#666;">No guides yet.</div>

    <div th:each="g : ${guides}" style="border:1px solid #eee; border-radius:8px; padding:12px; margin:8px 0;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h4 style="margin:0;" th:text="${g.title}">Guide title</h4>
            <form method="post" th:action="@{/flow/guides/delete/{id}(id=${g.id})}">
                <div th:replace="~{fragments/csrf :: csrf}"></div>
                <button type="submit">Delete</button>
            </form>
        </div>
        <div style="font-size:12px; color:#666; margin:4px 0;" th:text="${g.category}">RELAXATION</div>

        <div style="white-space:pre-wrap; margin-top:8px;" th:utext="${g.contentHtml}">
            Content...
        </div>

        <div th:if="${g.imageUrl}" style="margin-top:8px;">
            <div th:if="${#strings.containsIgnoreCase(g.imageUrl,'youtube') or #strings.containsIgnoreCase(g.imageUrl,'youtu.be')}">
                <iframe th:src="${#strings.contains(g.imageUrl,'watch?v=') ? 'https://www.youtube.com/embed/' + ${#strings.substring(g.imageUrl, #strings.indexOf(g.imageUrl,'=')+1)} : 'https://www.youtube.com/embed/' + ${#strings.substring(g.imageUrl, #strings.lastIndexOf(g.imageUrl,'/')+1)}}"
                        width="560" height="315" frameborder="0" allowfullscreen></iframe>
            </div>
            <div th:if="${!(#strings.containsIgnoreCase(g.imageUrl,'youtube') or #strings.containsIgnoreCase(g.imageUrl,'youtu.be'))}">
                <img th:src="${g.imageUrl}" alt="" style="max-width:100%; height:auto;">
            </div>
        </div>
    </div>
</div>

</body>
</html>

