<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Today')}"></head>
<body th:attr="data-mode=${hubMode}">
<div th:replace="~{fragments/hub-topbar :: hubTopbar(${hubMode}, ${hubRange}, ${hubDate})}"></div>

<div class="container my-4 today-container">
  <div class="row g-3" th:if="${hubMode == 'body'}">
    <div class="col-12">
      <div class="card section section-modern" data-section="today-workout" data-default="expanded"
           th:if="${hiddenSections['today-workout']} != true">
        <div class="card-header section-header">
          <div>
            <div class="section-title">Workout</div>
            <div class="section-meta" th:if="${vm.workoutTitle != null}"
                 th:text="${vm.workoutSetsDone + '/' + vm.workoutSetsTotal + ' sets'}">
              0/0 sets
            </div>
            <div class="section-meta" th:if="${vm.workoutTitle == null}">
              No workout logged yet.
            </div>
          </div>
          <div class="section-actions">
            <a class="btn btn-sm btn-secondary" th:href="@{/workout-plans}">Details</a>
            <form th:if="${vm.dailyWorkoutId != null}"
                  th:action="@{/today/{date}/workout/delete(date=${vm.date},mode=${hubMode},range=${hubRange})}"
                  method="post">
              <div th:replace="~{fragments/csrf :: csrf}"></div>
              <button type="submit" class="btn btn-sm btn-outline-accent">Remove</button>
            </form>
            <button class="btn btn-sm btn-ghost section-toggle" type="button" data-toggle-section="today-workout" aria-label="Toggle workout section">
              <span class="chevron-icon" aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="card-body section-body section-body-modern">
          <div class="section-block section-block-highlight">
            <div class="section-eyebrow">Today's focus</div>
            <div class="section-lead" th:text="${vm.workoutTitle != null ? vm.workoutTitle : 'No workout logged today'}">Workout</div>
            <div class="text-muted small" th:if="${vm.workoutTitle == null}">
              Add a workout from a plan day.
            </div>
          </div>

          <div class="section-block section-block-form" th:if="${vm.dailyWorkoutId == null}">
            <div class="section-block-header">
              <p class="section-block-subtitle mb-0">Pick a plan day to log today's workout.</p>
            </div>
            <div th:if="${vm.workoutPlanDays == null || #lists.isEmpty(vm.workoutPlanDays)}" class="text-muted small">
              No plan days yet.
              <a th:href="@{/workout-plans}">Create a workout plan</a>.
            </div>
            <form th:if="${vm.workoutPlanDays != null && !#lists.isEmpty(vm.workoutPlanDays)}"
                  th:action="@{/today/{date}/workout/add(date=${vm.date},mode=${hubMode},range=${hubRange})}"
                  method="post" class="form-inline-actions form-roomy section-form section-form-balanced">
              <div th:replace="~{fragments/csrf :: csrf}"></div>
              <div class="form-fields">
                <div class="span-8">
                  <label class="form-label mb-1">Plan day</label>
                  <select class="form-select form-select-sm" name="planDayId" required>
                    <option value="" disabled selected>Select day</option>
                    <option th:each="day : ${vm.workoutPlanDays}" th:value="${day.id}" th:text="${day.label}">Plan day</option>
                  </select>
                </div>
              </div>
              <div class="form-actions">
                <button class="btn btn-sm btn-primary" type="submit">+ Add</button>
              </div>
            </form>
            <div class="section-footnotes" th:if="${vm.workoutPlanDays != null && !#lists.isEmpty(vm.workoutPlanDays)}">
              <span>Missing a plan day? Use Details to edit your plan.</span>
            </div>
          </div>

          <div class="section-block" th:if="${vm.dailyWorkoutId != null}">
            <div class="table-wrap">
              <table class="table table-sm align-middle mb-0">
                <thead>
                <tr>
                  <th>Exercise</th>
                  <th>Set</th>
                  <th>Reps</th>
                  <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="set : ${vm.workoutSets}">
                  <td th:text="${set.exerciseName}">Exercise</td>
                  <td th:text="${set.setNumber}">1</td>
                  <td>
                    <form th:action="@{/today/{date}/workout/sets/{setId}/reps(date=${vm.date},setId=${set.setId},mode=${hubMode},range=${hubRange})}"
                          method="post" class="d-flex align-items-center gap-2 m-0 flex-wrap">
                      <div th:replace="~{fragments/csrf :: csrf}"></div>
                      <input type="number" min="0" class="form-control form-control-sm" name="repsDone"
                             th:value="${set.repsDone}">
                      <button class="btn btn-sm btn-secondary" type="submit">Save</button>
                    </form>
                  </td>
                  <td>
                <form th:action="@{/today/{date}/workout/sets/{setId}/delete(date=${vm.date},setId=${set.setId},mode=${hubMode},range=${hubRange})}"
                      method="post" class="m-0">
                  <div th:replace="~{fragments/csrf :: csrf}"></div>
                  <button class="btn btn-sm btn-outline-accent" type="submit">Delete</button>
                </form>
              </td>
            </tr>
            </tbody>
              </table>
            </div>

            <form th:action="@{/today/{date}/workout/{workoutId}/sets/add(date=${vm.date},workoutId=${vm.dailyWorkoutId},mode=${hubMode},range=${hubRange})}"
                  method="post" class="form-inline-actions form-roomy section-form section-form-balanced">
              <div th:replace="~{fragments/csrf :: csrf}"></div>
              <div class="form-fields">
                <div class="span-8">
                  <label class="form-label mb-1">Add set</label>
                  <select class="form-select form-select-sm" name="exerciseId" required>
                    <option value="" disabled selected>Pick exercise</option>
                    <option th:each="ex : ${vm.workoutExercises}" th:value="${ex.id}" th:text="${ex.name}">Exercise</option>
                  </select>
                </div>
              </div>
              <div class="form-actions">
                <button class="btn btn-sm btn-primary" type="submit">+ Add</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card section section-modern" data-section="today-meals" data-default="collapsed"
           th:if="${hiddenSections['today-meals']} != true">
        <div class="card-header section-header">
          <div>
            <div class="section-title">Meals</div>
            <div class="section-meta" th:with="tot=${vm.mealTotals}">
              kcal <span th:text="${tot != null ? tot.kcal : 0}">0</span>
              | P <span th:text="${tot != null ? tot.protein : 0}">0</span>
              / C <span th:text="${tot != null ? tot.carbs : 0}">0</span>
              / F <span th:text="${tot != null ? tot.fat : 0}">0</span>
            </div>
          </div>
          <div class="section-actions">
            <a class="btn btn-sm btn-secondary" th:href="@{/meals/today}">Details</a>
            <button class="btn btn-sm btn-ghost section-toggle" type="button" data-toggle-section="today-meals" aria-label="Toggle meals section">
              <span class="chevron-icon" aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="card-body section-body section-body-modern">
          <div class="section-block section-block-highlight">
            <div class="section-eyebrow">Quick log</div>
            <div class="section-lead">Add meals without opening the full diary.</div>
          </div>
          <div class="section-block section-block-form">
            <div class="section-block-header">
              <p class="section-block-subtitle mb-0">Quick log</p>
              <p class="section-block-subtitle mb-0">Add meals without opening the full diary.</p>
            </div>
            <form th:action="@{/today/{date}/meals/add-food(date=${vm.date},mode=${hubMode},range=${hubRange})}"
                  method="post" class="form-inline-actions form-roomy section-form section-form-balanced">
              <div th:replace="~{fragments/csrf :: csrf}"></div>
              <div class="form-fields">
                <div class="span-8">
                  <label class="form-label" for="todayMealFood">Food (database)</label>
                  <select id="todayMealFood" class="form-select form-select-sm" name="foodItemId" required>
                    <option value="" disabled selected>Select food</option>
                    <option th:each="f : ${vm.mealFoodOptions}"
                            th:value="${f.id}"
                            th:text="${f.label}">
                      Food
                    </option>
                  </select>
                </div>
                <div class="span-2">
                  <label class="form-label" for="todayMealSegment">Meal</label>
                  <select id="todayMealSegment" class="form-select form-select-sm" name="segment" required>
                    <option value="breakfast">Breakfast</option>
                    <option value="lunch">Lunch</option>
                    <option value="dinner">Dinner</option>
                    <option value="snacks">Snacks</option>
                  </select>
                </div>
                <div class="span-2">
                  <label class="form-label" for="todayMealQuantity">Qty</label>
                  <input id="todayMealQuantity" type="number" class="form-control form-control-sm" name="quantity" min="1" value="100">
                </div>
              </div>
              <div class="form-actions">
                <button class="btn btn-sm btn-primary" type="submit">+ Add</button>
              </div>
            </form>
            <div class="section-footnotes">
              <span>Quantity uses grams for foods defined per 100g.</span>
              <span>Missing a food? Add it in <a th:href="@{/meals/today}">Details</a>.</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card section section-modern" data-section="today-body-stats" data-default="collapsed"
           th:if="${hiddenSections['today-body-stats']} != true">
        <div class="card-header section-header">
          <div>
            <div class="section-title">Body Stats</div>
            <div class="section-meta" th:if="${vm.todayWeight != null}">
              Today: <span th:text="${vm.todayWeight}">0</span> kg
            </div>
            <div class="section-meta" th:if="${vm.todayWeight == null && vm.latestWeight != null}">
              Latest: <span th:text="${vm.latestWeight}">0</span> kg
            </div>
            <div class="section-meta" th:if="${vm.todayWeight == null && vm.latestWeight == null}">
              No weight logged yet.
            </div>
          </div>
          <div class="section-actions">
            <a class="btn btn-sm btn-secondary" th:href="@{/body-stats}" 
               th:text="${vm.todayWeight != null} ? 'Details / Edit' : 'Details'">Details</a>
            <button class="btn btn-sm btn-ghost section-toggle" type="button" data-toggle-section="today-body-stats" aria-label="Toggle body stats section">
              <span class="chevron-icon" aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="card-body section-body section-body-modern">
          <div class="section-block section-block-highlight">
            <div class="section-eyebrow">Progress snapshot</div>
            <div class="section-lead">Track today's weight to see your trend over time.</div>
            <div class="text-muted small" th:if="${vm.todayBodyFatPercent != null}"
                 th:text="'Body fat ' + ${vm.todayBodyFatPercent} + '%'">Body fat</div>
          </div>

          <div class="section-block section-block-metrics">
            <div class="metric-tiles">
              <div class="metric-tile">
                <div class="metric-label">Latest weight</div>
                <div class="metric-value">
                  <span th:text="${vm.todayWeight != null ? vm.todayWeight : vm.latestWeight != null ? vm.latestWeight : '--'}">0.0</span>
                  <span class="metric-unit">kg</span>
                </div>
                <div class="metric-footnote">Uses today's entry when available.</div>
              </div>
              <div class="metric-tile">
                <div class="metric-label">Body fat</div>
                <div class="metric-value">
                  <span th:text="${vm.todayBodyFatPercent != null ? vm.todayBodyFatPercent : '--'}">--</span>
                  <span class="metric-unit">%</span>
                </div>
                <div class="metric-footnote">Keep it aligned with your weight updates.</div>
              </div>
            </div>
          </div>

          <div class="section-block section-block-chart">
            <div class="section-block-header">
              <p class="section-block-subtitle mb-1">7-day trend</p>
              <p class="section-block-subtitle text-muted mb-0">Latest entries shown; defaults to zeroed placeholders.</p>
            </div>
            <canvas id="todayWeightChart" height="140"></canvas>
          </div>

          <div class="section-block section-block-form">
            <div class="section-block-header">
              <p class="section-block-subtitle mb-0">Log today's stats quickly.</p>
              <p class="section-block-subtitle mb-0">Keep weight and body fat aligned with your snapshot.</p>
            </div>
            <form th:if="${vm.todayWeight == null}"
                  th:action="@{/today/{date}/body-stats/add(date=${vm.date},mode=${hubMode},range=${hubRange})}"
                  method="post" class="form-inline-actions form-roomy section-form section-form-balanced">
              <div th:replace="~{fragments/csrf :: csrf}"></div>
              <div class="form-fields">
                <div class="span-8">
                  <label class="form-label" for="todayWeight">Weight (kg)</label>
                  <input id="todayWeight" type="number" step="0.1" min="0" name="weight"
                         class="form-control form-control-sm" required>
                </div>
                <div class="span-4">
                  <label class="form-label" for="todayBodyFat">Body fat % (optional)</label>
                  <input id="todayBodyFat" type="number" step="0.1" min="0" name="bodyFatPercent"
                         class="form-control form-control-sm">
                </div>
              </div>
              <div class="form-actions">
                <button class="btn btn-sm btn-primary" type="submit">Save</button>
              </div>
            </form>
            <div class="text-muted small" th:if="${vm.todayWeight != null}">
              Logged for today.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3" th:if="${hubMode == 'mind'}">
    <div class="col-12">
        <div class="card section" data-section="today-tasks" data-default="expanded"
           th:if="${hiddenSections['today-tasks']} != true">
        <div class="card-header section-header">
          <div>
            <div class="section-title">Tasks</div>
            <div class="section-meta"
                 th:text="${vm.tasksDone + '/' + vm.tasksTotal}">0/0</div>
          </div>
          <div class="section-actions">
            <form th:action="@{/today/{date}/tasks/copy-yesterday(date=${vm.date},mode=${hubMode},range=${hubRange})}"
                  method="post" class="m-0">
              <div th:replace="~{fragments/csrf :: csrf}"></div>
              <button class="btn btn-sm btn-secondary" type="submit">Copy</button>
            </form>
            <a class="btn btn-sm btn-secondary" th:href="@{/flow/tasks}">Details</a>
            <button class="btn btn-sm btn-ghost section-toggle" type="button" data-toggle-section="today-tasks" aria-label="Toggle tasks section">
              <span class="chevron-icon" aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="card-body section-body">
          <div class="fw-semibold">Top Tasks</div>
          <form th:action="@{/today/{date}/tasks/add(date=${vm.date},mode=${hubMode},range=${hubRange})}"
                method="post" class="form-inline-actions form-compact">
            <div th:replace="~{fragments/csrf :: csrf}"></div>
            <div class="form-fields">
              <div class="span-12">
                <input type="text" name="title" class="form-control form-control-sm" placeholder="Quick add task" required>
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-sm btn-primary" type="submit">+ Add</button>
            </div>
          </form>
          <div class="mb-3">
            <div class="text-muted small" th:if="${#lists.isEmpty(vm.topTasks)}">No tasks for this day.</div>
            <div class="list-group today-list" th:if="${!#lists.isEmpty(vm.topTasks)}">
              <div class="list-group-item d-flex align-items-center gap-2"
                   th:each="t : ${vm.topTasks}">
                <form th:action="@{/today/{date}/tasks/{id}/toggle(date=${vm.date},id=${t.id},mode=${hubMode},range=${hubRange})}"
                      method="post" class="m-0">
                  <div th:replace="~{fragments/csrf :: csrf}"></div>
                  <input class="form-check-input js-auto-submit" type="checkbox" th:checked="${t.done}">
                </form>
                <span th:text="${t.title}" th:classappend="${t.done} ? 'text-decoration-line-through text-muted' : ''">Task</span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card section" data-section="today-habits" data-default="collapsed"
           th:if="${hiddenSections['today-habits']} != true">
        <div class="card-header section-header">
          <div>
            <div class="section-title">Habits</div>
            <div class="section-meta"
                 th:text="${vm.habitsDone + '/' + vm.habitsTotal}">0/0</div>
          </div>
          <div class="section-actions">
            <a class="btn btn-sm btn-secondary" th:href="@{/flow/habits}">Details</a>
            <button class="btn btn-sm btn-ghost section-toggle" type="button" data-toggle-section="today-habits" aria-label="Toggle habits section">
              <span class="chevron-icon" aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="card-body section-body">
          <div class="text-muted small" th:if="${#lists.isEmpty(vm.habits)}">No habits yet.</div>
          <div class="list-group today-list" th:if="${!#lists.isEmpty(vm.habits)}">
            <div class="list-group-item d-flex align-items-center gap-2"
                 th:each="h : ${vm.habits}">
              <form th:action="@{/today/{date}/habits/{id}/toggle(date=${vm.date},id=${h.id},mode=${hubMode},range=${hubRange})}"
                    method="post" class="m-0">
                <div th:replace="~{fragments/csrf :: csrf}"></div>
                <input class="form-check-input js-auto-submit" type="checkbox" th:checked="${h.done}">
              </form>
              <span th:text="${h.name}" th:classappend="${h.done} ? 'text-decoration-line-through text-muted' : ''">Habit</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card section" data-section="today-sleep" data-default="collapsed"
           th:if="${hiddenSections['today-sleep']} != true">
        <div class="card-header section-header">
          <div>
            <div class="section-title">Sleep</div>
            <div class="section-meta" th:if="${vm.sleepHours != null}"
                 th:text="${vm.sleepHours + 'h ' + vm.sleepMinutes + 'm - quality ' + vm.sleepQuality}">
              0h 0m - quality 0
            </div>
            <div class="section-meta" th:if="${vm.sleepHours == null}">
              No sleep logged for last night.
            </div>
          </div>
          <div class="section-actions">
            <a class="btn btn-sm btn-secondary" th:href="@{/mind/sleep}">Details</a>
            <button class="btn btn-sm btn-ghost section-toggle" type="button" data-toggle-section="today-sleep" aria-label="Toggle sleep section">
              <span class="chevron-icon" aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="card-body section-body">
          <form th:action="@{/today/{date}/sleep/add(date=${vm.date},mode=${hubMode},range=${hubRange})}"
                method="post" class="form-inline-actions form-roomy form-compact">
            <div th:replace="~{fragments/csrf :: csrf}"></div>
            <div class="form-fields">
              <div class="span-8">
                <label class="form-label">Duration (hh:mm)</label>
                <div class="sleep-duration">
                  <input id="todaySleepHours" type="number" min="0" max="24" name="hours"
                         class="form-control form-control-sm" placeholder="7" required>
                  <span class="duration-sep">:</span>
                  <input id="todaySleepMinutes" type="number" min="0" max="59" name="minutes"
                         class="form-control form-control-sm" placeholder="30" required>
                </div>
              </div>
              <div class="span-4">
                <label class="form-label" for="todaySleepQuality">Quality (1-5)</label>
                <input id="todaySleepQuality" type="number" min="1" max="5" name="quality"
                       class="form-control form-control-sm" placeholder="1-5" required>
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-sm btn-primary" type="submit">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card section" data-section="today-review" data-default="collapsed"
           th:if="${hiddenSections['today-review']} != true">
        <div class="card-header section-header">
          <div>
            <div class="section-title">Review</div>
            <div class="section-meta" th:if="${vm.reviewPresent}">
              Saved for this day.
            </div>
            <div class="section-meta" th:if="${!vm.reviewPresent}">
              Log your mood, energy, and quick note.
            </div>
          </div>
          <div class="section-actions">
            <button class="btn btn-sm btn-ghost section-toggle" type="button" data-toggle-section="today-review" aria-label="Toggle review section">
              <span class="chevron-icon" aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="card-body section-body">
          <form th:action="@{/today/{date}/review(date=${vm.date},mode=${hubMode},range=${hubRange})}" method="post" th:object="${dailyReviewForm}" class="form-grid form-roomy form-compact">
            <div th:replace="~{fragments/csrf :: csrf}"></div>
            <div class="span-6">
              <label class="form-label" for="reviewMood">Mood (1-5)</label>
              <input id="reviewMood" type="number" min="1" max="5" class="form-control form-control-sm" th:field="*{mood}">
              <div class="text-danger small" th:if="${#fields.hasErrors('mood')}" th:errors="*{mood}"></div>
            </div>
            <div class="span-6">
              <label class="form-label" for="reviewEnergy">Energy (1-5)</label>
              <input id="reviewEnergy" type="number" min="1" max="5" class="form-control form-control-sm" th:field="*{energy}">
              <div class="text-danger small" th:if="${#fields.hasErrors('energy')}" th:errors="*{energy}"></div>
            </div>
            <div class="span-12">
              <label class="form-label" for="reviewNote">Note</label>
              <textarea id="reviewNote" class="form-control form-control-sm" rows="3" th:field="*{note}" placeholder="Short note (optional)"></textarea>
            </div>
            <div class="span-12 d-flex align-items-center gap-2">
              <input id="reviewReset" class="form-check-input" type="checkbox" th:field="*{resetDone}">
              <label class="form-check-label" for="reviewReset">Reset done</label>
            </div>
            <div class="span-12 d-flex justify-content-end">
              <button class="btn btn-primary btn-sm">Save review</button>
            </div>
          </form>

          <div class="d-flex flex-wrap align-items-center gap-2 mt-3"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container pb-4" th:if="${hiddenItems != null && !#lists.isEmpty(hiddenItems)}">
  <div class="text-muted small">
    Some sections are hidden. You can manage them in
    <a th:href="@{/settings}">Settings</a>.
  </div>
</div>

<script th:inline="javascript">
  const weightLabels = [[${vm.weightDates}]];
  const weightValues = [[${vm.weightValues}]];
  const ctx = document.getElementById("todayWeightChart");
  if (ctx) {
    new Chart(ctx, {
      type: "line",
      data: {
        labels: weightLabels,
        datasets: [{
          label: "Weight (kg)",
          data: weightValues,
          borderColor: "#3b82f6",
          backgroundColor: "rgba(59, 130, 246, 0.12)",
          borderWidth: 2,
          tension: 0.35,
          pointRadius: 3,
          pointBackgroundColor: "#3b82f6",
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { display: false },
          y: { display: false }
        },
        interaction: {
          intersect: false,
          mode: "index"
        }
      }
    });
  }
</script>
<script th:src="@{/js/auto-submit.js}" defer></script>
<script th:src="@{/js/section-toggle.js}" defer></script>
</body>
</html>



