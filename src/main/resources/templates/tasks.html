<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/head :: head('Flow tasks')}"></head>
<body class="bg-light">

<nav th:replace="~{fragments/nav :: nav}"></nav>

<main class="container py-4">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <h2 class="m-0">Tasks - daily checklist</h2>
    <form class="d-flex flex-wrap gap-2" method="get" th:action="@{/flow/tasks}">
      <input id="dateFilter" name="date" type="date" class="form-control" th:value="${date}">
      <button class="btn btn-outline-primary" type="submit">Go</button>
    </form>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-5">
      <div class="card h-100">
        <div class="card-header">Add task</div>
        <div class="card-body">
          <div class="alert alert-warning py-2" th:if="${topLimitReached}">
            You can select up to 3 top tasks for the day.
          </div>
          <form th:action="@{/flow/tasks/add}" th:object="${taskForm}" method="post" class="row g-2">
            <div th:replace="~{fragments/csrf :: csrf}"></div>
            <div class="col-12" th:if="${#fields.hasErrors('*')}">
              <div class="alert alert-danger py-2">
                <div th:each="err : ${#fields.errors('*')}" th:text="${err}">Invalid input</div>
              </div>
            </div>
            <div class="col-12">
              <label class="form-label" for="taskDate">Date</label>
              <input id="taskDate" type="date" th:field="*{date}" class="form-control">
              <div class="text-danger small" th:if="${#fields.hasErrors('date')}" th:errors="*{date}"></div>
            </div>
            <div class="col-12">
              <label class="form-label" for="title">Title</label>
              <input id="title" type="text" th:field="*{title}" class="form-control" placeholder="Task title">
              <div class="text-danger small" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
            </div>
            <div class="col-12">
              <label class="form-label" for="notes">Notes (optional)</label>
              <textarea id="notes" th:field="*{notes}" class="form-control" rows="2"></textarea>
              <div class="text-danger small" th:if="${#fields.hasErrors('notes')}" th:errors="*{notes}"></div>
            </div>
            <div class="col-12">
              <label class="form-label" for="priority">Priority</label>
              <select id="priority" class="form-select" th:field="*{priority}">
                <option value="LOW">Low</option>
                <option value="MEDIUM" selected>Medium</option>
                <option value="HIGH">High</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label" for="dueDate">Due date (optional)</label>
              <input id="dueDate" type="date" th:field="*{dueDate}" class="form-control">
              <div class="text-danger small" th:if="${#fields.hasErrors('dueDate')}" th:errors="*{dueDate}"></div>
            </div>
            <div class="col-12">
              <button class="btn btn-success">Add</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-7">
      <div class="card h-100">
        <div class="card-header">Tasks for <span th:text="${date}">today</span></div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item text-muted text-center" th:if="${#lists.isEmpty(tasks)}">No tasks yet.</li>
          <li class="list-group-item" th:each="t : ${tasks}">
            <div class="d-flex align-items-start gap-3">
              <form method="post" th:action="@{/flow/tasks/toggle/{id}(id=${t.id})}">
                <div th:replace="~{fragments/csrf :: csrf}"></div>
                <input type="hidden" name="date" th:value="${date}">
                <button type="submit" class="btn btn-outline-secondary btn-sm" th:text="${t.done} ? 'Done' : 'Do'">Do</button>
              </form>

              <div class="flex-grow-1">
                <div class="fw-semibold" th:text="${t.title}"
                     th:style="${t.done} ? 'text-decoration: line-through; color:#888;' : ''">Task title</div>
                <div class="small text-muted" th:if="${t.notes != null and !#strings.isEmpty(t.notes)}" th:text="${t.notes}">Notes</div>
                <div class="small text-muted" th:if="${t.dueDate != null}">
                  Due: <span th:text="${t.dueDate}">2025-08-30</span>
                </div>
                <div class="small text-muted" th:if="${t.completedDate != null}">
                  Completed: <span th:text="${t.completedDate}">2025-08-20</span>
                </div>
                <div class="small" th:if="${t.priority != null}">
                  Priority: <span class="badge text-bg-secondary" th:text="${t.priority}">MEDIUM</span>
                </div>
                <div class="small" th:if="${t.top}">
                  <span class="badge text-bg-warning">Top task</span>
                </div>
              </div>

              <form method="post" th:action="@{/flow/tasks/top/{id}(id=${t.id})}">
                <div th:replace="~{fragments/csrf :: csrf}"></div>
                <input type="hidden" name="date" th:value="${date}">
                <button type="submit" class="btn btn-outline-warning btn-sm" th:text="${t.top} ? 'Unpin' : 'Top'">Top</button>
              </form>

              <form method="post" th:action="@{/flow/tasks/delete/{id}(id=${t.id})}">
                <div th:replace="~{fragments/csrf :: csrf}"></div>
                <input type="hidden" name="date" th:value="${date}">
                <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
              </form>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <a href="/flow/habits" class="btn btn-outline-secondary">Back to Habits</a>
    <a href="/today" class="btn btn-outline-secondary">Back to Today</a>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
